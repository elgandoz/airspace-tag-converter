<!DOCTYPE html>
<html>
  <head>
    <title>CUP to OpenAir Converter</title>
    <!-- Include Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="mt-3">CUP to OpenAir Converter</h1>

      <form class="mt-3">
        <div class="mb-3">
          <label for="cupFile" class="form-label"
            >Select a SeeYou CUP file:</label
          >
          <input
            type="file"
            class="form-control"
            id="cupFile"
            accept=".cup"
            required
          />
        </div>

        <div class="mb-3">
          <label for="category" class="form-label">Airspace Category</label>
          <input
            type="text"
            class="form-control"
            id="category"
            maxlength="5"
            placeholder="F"
          />
          <div id="categoryHelp" class="form-text">
            Max 5 letters, default is 'F. This will change the color and
            behaviour of the airspaces.
            <br />See the available classes of the
            <a
              href="http://www.winpilot.com/usersguide/userairspace.asp"
              target="_blank"
              >WinPilot OpenAir airspace format</a
            >
          </div>
        </div>

        <div class="mb-3">
          <label for="radius" class="form-label"
            >Radius in meters (default is 400):</label
          >
          <input
            type="number"
            class="form-control"
            id="radius"
            min="1"
            placeholder="400"
          />
        </div>

        <button
          type="button"
          class="btn btn-primary"
          onclick="convertCUPtoOpenAir()"
        >
          Convert
        </button>
      </form>

      <hr class="mt-4" />

      <button
        id="downloadButton"
        class="btn btn-primary"
        onclick="downloadOpenAirFile()"
        style="display: none"
      >
        Download OpenAir File
      </button>

      <h2 class="mt-3">OpenAir airspace content:</h2>
      <pre id="openAirContent" style="overflow: auto; max-height: 300px"></pre>
    </div>

    <!-- Include Bootstrap JavaScript (for Bootstrap 5) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      console.debug('CUP to OpenAir Converter')

      function convertCoordinateToSexagesimal(coordinate) {
        const direction = coordinate.slice(-1)
        const minutesDec = parseFloat(coordinate.substr(-7, 6))
        const minutes = Math.floor(minutesDec).toString().padStart(2, '0')
        const seconds = Math.round((minutesDec - Math.floor(minutesDec)) * 60)
          .toString()
          .padStart(2, '0')
        let length = 3
        if (['N', 'S'].includes(direction)) {
          length = 2
        }
        const degrees = coordinate.substr(0, length)

        return `${degrees}:${minutes}:${seconds} ${direction}`
      }

      function convertMetersToNauticalMiles(meters) {
        // 1 meter is approximately 0.00053996 nautical miles
        return (meters * 0.00053996).toFixed(4)
      }

      function convertCUPtoOpenAir() {
        const cupFileInput = document.getElementById('cupFile')
        const openAirContent = document.getElementById('openAirContent')
        const categoryInput = document.getElementById('category')
        const radiusInput = document.getElementById('radius')
        const downloadButton = document.getElementById('downloadButton')

        const cupFile = cupFileInput.files[0]
        if (!cupFile) {
          alert('Please select a CUP file to convert.')
          return
        }

        const reader = new FileReader()

        reader.onload = function (e) {
          const cupContent = e.target.result
          const cupLines = cupContent.split('\n')

          let openAirContentText = ''

          let inRelatedTasks = false

          // Skip the first line (header)
          let skipFirstLine = true

          const category =
            categoryInput.value.toUpperCase().substring(0, 5) || 'F'
          const radius = convertMetersToNauticalMiles(radiusInput.value || 400)

          for (const line of cupLines) {
            if (skipFirstLine) {
              skipFirstLine = false
              continue
            }

            if (line.trim() === '-----Related Tasks-----') {
              break // Exit the loop when "-----Related Tasks-----" is encountered
            }

            const fields = line.split(',')
            if (fields.length >= 5) {
              const name = fields[0].replace(/"/g, '')
              const code = fields[1]
              const lat = convertCoordinateToSexagesimal(fields[3])
              const lon = convertCoordinateToSexagesimal(fields[4])

              const airspaceName = `AN ${code} ${name}`
              const center = `V X=${lat} ${lon}`
              const radiusParam = `DC ${radius}` // Radius in nautical miles

              openAirContentText += `AC ${category}\n${airspaceName}\nAL SFC\nAH UNL\n${center}\n${radiusParam}\n\n`
            }
          }

          openAirContent.textContent = openAirContentText
          downloadButton.style.display = 'block'
        }

        reader.readAsText(cupFile)
      }

      function downloadOpenAirFile() {
        const openAirContent =
          document.getElementById('openAirContent').textContent
        const filename =
          (document
            .getElementById('cupFile')
            .files[0].name.replace('.cup', '') || 'airspace') + '-airspace.txt'
        const blob = new Blob([openAirContent], { type: 'text/plain' })
        const link = document.createElement('a')
        link.href = URL.createObjectURL(blob)
        link.download = filename
        link.click()
      }
    </script>
  </body>
</html>
